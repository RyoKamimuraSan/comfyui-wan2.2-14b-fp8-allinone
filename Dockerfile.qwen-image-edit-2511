# ============================================
# ComfyUI All-in-One Docker Image
# qwen-image-edit-2511 プリインストール版
# ============================================

# ベースイメージ
FROM pytorch/pytorch:2.9.1-cuda12.6-cudnn9-runtime

# 環境変数
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PIP_NO_CACHE_DIR=1

# Civitai APIキー（ビルド時に指定）
ARG CIVITAI_API_KEY=""
ENV CIVITAI_API_KEY=${CIVITAI_API_KEY}

# ============================================
# モデルダウンロードURL設定（環境変数で上書き可能）
# ============================================
ENV CHECKPOINT_URLS=""
ENV VAE_URLS=""
ENV LORA_URLS=""
ENV CONTROLNET_URLS=""
ENV UPSCALE_URLS="\
4x-UltraSharp.pth::https://huggingface.co/lokCX/4x-Ultrasharp/resolve/main/4x-UltraSharp.pth \
"
ENV CLIP_URLS=""
ENV UNET_URLS=""
ENV TEXT_ENCODER_URLS=""
ENV DIFFUSION_MODEL_URLS=""
ENV ULTRALYTICS_BBOX_URLS=""

# ============================================
# Custom Node インストール設定（環境変数で上書き可能）
# ============================================
ENV CUSTOM_NODE_URLS="\
https://github.com/Comfy-Org/ComfyUI-Manager \
https://github.com/MoonGoblinDev/Civicomfy \
https://github.com/Kosinkadink/ComfyUI-VideoHelperSuite \
https://github.com/ltdrdata/ComfyUI-Impact-Pack \
https://github.com/1038lab/ComfyUI-RMBG \
https://github.com/rgthree/rgthree-comfy \
https://github.com/kijai/ComfyUI-KJNodes \
https://github.com/Fannovel16/ComfyUI-Frame-Interpolation \
https://github.com/pythongosssss/ComfyUI-Custom-Scripts \
"

# ============================================
# システムパッケージのインストール
# ============================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    aria2 \
    libgl1-mesa-glx \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender1 \
    && rm -rf /var/lib/apt/lists/*

# ============================================
# ComfyUIのインストール
# ============================================
WORKDIR /app

# ComfyUIをクローン
RUN git clone https://github.com/comfyanonymous/ComfyUI.git . \
    && rm -rf .git

# ComfyUIの依存関係 + JupyterLab をインストール
RUN pip install -r requirements.txt jupyterlab && \
    find /opt/conda/lib/python*/site-packages -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true

# ============================================
# ディレクトリ構造の作成
# ============================================
RUN mkdir -p \
    /app/models/checkpoints \
    /app/models/vae \
    /app/models/loras \
    /app/models/controlnet \
    /app/models/upscale_models \
    /app/models/clip \
    /app/models/unet \
    /app/models/text_encoders \
    /app/models/diffusion_models \
    /app/models/ultralytics/bbox \
    /app/input \
    /app/output \
    /app/custom_nodes

# ============================================
# スクリプトをコピー
# ============================================
COPY scripts/download_model.sh /usr/local/bin/
COPY scripts/download_models.sh /usr/local/bin/
COPY scripts/install_custom_nodes.sh /usr/local/bin/
COPY scripts/start.sh /app/
COPY scripts/start-paperspace.sh /app/

# 実行権限付与
RUN chmod +x /usr/local/bin/*.sh /app/*.sh

# ============================================
# qwen-image-edit-2511 モデルのプリインストール
# ダウンロード失敗時は警告を出してスキップ（ビルドは継続）
# ============================================

# checkpoints (Civitai - API key required)
RUN /usr/local/bin/download_model.sh /app/models/checkpoints \
    "2dn_animeV3.safetensors::https://civitai.com/api/download/models/2556635?type=Model&format=SafeTensor&size=pruned&fp=fp16"

# diffusion_models (HuggingFace)
RUN /usr/local/bin/download_model.sh /app/models/diffusion_models \
    "qwen_image_edit_2511_fp8_e4m3fn_scaled_lightning_8steps_v1.0.safetensors::https://huggingface.co/lightx2v/Qwen-Image-Edit-2511-Lightning/resolve/main/qwen_image_edit_2511_fp8_e4m3fn_scaled_lightning_8steps_v1.0.safetensors"

# loras (Civitai + HuggingFace)
RUN /usr/local/bin/download_model.sh /app/models/loras \
    "qwen-image_nsfw_adv_v1.0.safetensors::https://civitai.com/api/download/models/2328988?type=Model&format=SafeTensor"
RUN /usr/local/bin/download_model.sh /app/models/loras \
    "NoobV065sHyperDmd.safetensors::https://huggingface.co/Zuntan/NoobHyperDmd/resolve/main/NoobV065sHyperDmd.safetensors"

# text_encoders (HuggingFace)
RUN /usr/local/bin/download_model.sh /app/models/text_encoders \
    "qwen_2.5_vl_7b_fp8_scaled.safetensors::https://huggingface.co/Comfy-Org/Qwen-Image_ComfyUI/resolve/main/split_files/text_encoders/qwen_2.5_vl_7b_fp8_scaled.safetensors"

# vae (HuggingFace)
RUN /usr/local/bin/download_model.sh /app/models/vae \
    "qwen_image_vae.safetensors::https://huggingface.co/Comfy-Org/Qwen-Image_ComfyUI/resolve/main/split_files/vae/qwen_image_vae.safetensors"

# ultralytics/bbox (HuggingFace)
RUN /usr/local/bin/download_model.sh /app/models/ultralytics/bbox \
    "Anzhc Breasts Seg v1 1024m.pt::https://huggingface.co/Anzhc/Anzhcs_YOLOs/resolve/main/Anzhc%20Breasts%20Seg%20v1%201024m.pt"
RUN /usr/local/bin/download_model.sh /app/models/ultralytics/bbox \
    "Anzhc Eyes -seg-hd.pt::https://huggingface.co/Anzhc/Anzhcs_YOLOs/resolve/main/Anzhc%20Eyes%20-seg-hd.pt"
RUN /usr/local/bin/download_model.sh /app/models/ultralytics/bbox \
    "Anzhc Face -seg.pt::https://huggingface.co/Anzhc/Anzhcs_YOLOs/resolve/main/Anzhc%20Face%20-seg.pt"

# ============================================
# ポート公開
# ============================================
EXPOSE 6006 8888

# ============================================
# 起動コマンド（デフォルトはスタンドアロン用）
# ============================================
CMD ["/app/start.sh"]
